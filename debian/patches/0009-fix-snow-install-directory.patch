Add /usr/local to default module search path

We're going to make Snow install its packages into proper /usr/local
hierarchy. For this we need to set up "sexp_default_module_path" to
include these paths. Note that architecture-independent Scheme code
and native libraries are going to be installed into different paths
with multiarch support.

Note that we have to fix up Snow source code as well to ensure that.
Normally it queries (current-module-path) for Chibi Scheme (see
get-install-dirs in commands.scm), but shared library directories
have just /usr/local/lib hardcoded. We use the similar approach to
extract the binary library path from (current-module-path).

--- a/Makefile
+++ b/Makefile
@@ -131,7 +131,7 @@
 
 include/chibi/install.h: Makefile
 	echo '#define sexp_so_extension "'$(SO)'"' > $@
-	echo '#define sexp_default_module_path "'$(MODDIR):$(BINMODDIR)'"' >> $@
+	echo '#define sexp_default_module_path "'$(MODDIR):$(BINMODDIR):$(SNOWMODDIR):$(SNOWBINMODDIR)'"' >> $@
 	echo '#define sexp_platform "'$(PLATFORM)'"' >> $@
 	echo '#define sexp_version "'$(VERSION)'"' >> $@
 	echo '#define sexp_release_name "'`cat RELEASE`'"' >> $@
--- a/Makefile.libs
+++ b/Makefile.libs
@@ -37,6 +37,12 @@
 PKGCONFDIR ?= $(SOLIBDIR)/pkgconfig
 MANDIR    ?= $(PREFIX)/share/man/man1
 
+SNOWPREFIX    ?= /usr/local
+SNOWLIBDIR    ?= $(PREFIX)/lib
+SNOWMODDIR    ?= $(SNOWPREFIX)/share/snow
+SNOWSOLIBDIR  ?= $(SNOWLIBDIR)
+SNOWBINMODDIR ?= $(SNOWSOLIBDIR)/snow
+
 DESTDIR   ?=
 
 ########################################################################
--- a/configure
+++ b/configure
@@ -6,6 +6,7 @@
 select(FH);
 
 my $prefix;
+my $libdir;
 
 foreach my $arg (@ARGV) {
     if ($arg =~ m/^--(.*)=(.*)$/) {
@@ -15,6 +16,10 @@
             if ($name eq 'prefix') {
                 $prefix = $value;
             }
+            if ($name eq 'libdir') {
+                $libdir = $value;
+                $libdir =~ s/\$\{prefix\}/$prefix/;
+            }
             $name = uc $name;
             $value =~ s/\$\{prefix\}/$prefix/;
             print qq($name="$value"\n);
@@ -22,4 +27,9 @@
     }
 }
 
+my $libdir_suffix = substr($libdir, length($prefix) + 1);
+
+print qq(SNOWPREFIX="/usr/local"\n);
+print qq(SNOWLIBDIR="/usr/local/$libdir_suffix"\n);
+
 close(FH);
--- a/lib/chibi/snow/commands.scm
+++ b/lib/chibi/snow/commands.scm
@@ -1352,6 +1352,24 @@
                       "share/snow"
                       impl)))))
 
+(define (get-install-library-dirs impl cfg)
+  (case impl
+    ((chibi)
+     (let* ((dirs
+             (reverse
+              (cond-expand
+               (chibi (eval '(current-module-path) (environment '(chibi))))
+               (else (process->sexp
+                      '(chibi-scheme -q -p "(current-module-path)"))))))
+            (lib-dir (find (lambda (d) (string-contains d "/lib")) dirs)))
+       (if lib-dir
+           (cons lib-dir (delete lib-dir dirs))
+           dirs)))
+    (else
+     (list (make-path (or (conf-get cfg 'install-prefix) "/usr/local")
+                      "lib"
+                      impl)))))
+
 (define (scheme-script-command impl cfg)
   (or (and (eq? impl 'chibi) (conf-get cfg 'chibi-path))
       (let* ((prog (cond ((conf-get cfg 'scheme-script))
@@ -1630,7 +1648,7 @@
     (car (get-install-dirs impl cfg)))
    ((conf-get cfg 'install-prefix)
     => (lambda (prefix) (make-path prefix "lib" impl)))
-   (else (make-path "/usr/local/lib" impl))))
+   (else (car (get-install-library-dirs impl cfg)))))
 
 (define (get-install-binary-dir impl cfg)
   (cond
